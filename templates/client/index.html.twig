{% extends 'base.html.twig' %}

{% block title %}Clients - DocManager{% endblock %}

{% block body %}
	<div class="page-header">
		<div>
			<h1 class="page-title">ğŸ‘¥ Clients</h1>
			<p class="page-subtitle">Manage your clients and their documents</p>
		</div>
		<div class="page-actions">
			{% if is_granted('clients.create') %}
				<a href="{{ path('app_client_new') }}" class="btn btn-primary">â• New Client</a>
			{% endif %}
		</div>
	</div>

	{# Stats #}
	<div class="stats-grid">
		<div class="stat-card">
			<div class="stat-icon cyan">ğŸ‘¥</div>
			<div>
				<div class="stat-value">{{ clients|length }}</div>
				<div class="stat-label">Total Clients</div>
			</div>
		</div>
	</div>

	{# Search & Filters #}
	<div class="card" style="padding: 1rem; margin-bottom: 1.5rem;">
		<div class="search-box" style="max-width: 100%;">
			<span class="search-box-icon">ğŸ”</span>
			<input type="search" class="form-control" placeholder="Search clients by name or email..." id="clientSearch" onkeyup="filterClients()">
		</div>
	</div>

	{% if clients is empty %}
		<div class="card">
			<div class="empty-state">
				<div class="empty-state-icon">ğŸ‘¥</div>
				<h3>No clients yet</h3>
				<p>Create your first client to start managing documents.</p>
				{% if is_granted('clients.create') %}
					<a href="{{ path('app_client_new') }}" class="btn btn-primary">â• Create Client</a>
				{% endif %}
			</div>
		</div>
	{% else %}
		<div class="card" style="padding: 0; overflow: hidden;">
			<div class="table-container">
				<table id="clientsTable">
					<thead>
						<tr>
							<th>Name</th>
							<th>Email</th>
							<th>Phone</th>
							{# Documents column - controlled by permission #}
							{% if is_granted('clients.view_documents_column') %}
								<th>Documents</th>
							{% endif %}
							<th>Created</th>
							{# Actions column - controlled by permission #}
							{% if is_granted('clients.view_actions_column') %}
								<th>Actions</th>
							{% endif %}
						</tr>
					</thead>
					<tbody>
						{% for client in clients %}
							<tr>
								<td>
									{# Name always shown, but link controlled by permission #}
									{% if is_granted('clients.view_details') %}
										<a href="{{ path('app_client_show', {id: client.id}) }}" style="font-weight: 600; color: var(--text-primary);">
											{{ client.firstName }}
											{{ client.lastName }}
										</a>
									{% else %}
										<span style="font-weight: 600; color: var(--text-primary);">
											{{ client.firstName }}
											{{ client.lastName }}
										</span>
									{% endif %}
								</td>
								<td>{{ client.email ?? '<span class="text-muted">â€”</span>'|raw }}</td>
								<td>{{ client.phone ?? '<span class="text-muted">â€”</span>'|raw }}</td>
								{# Documents column - controlled by permission #}
								{% if is_granted('clients.view_documents_column') %}
									<td>
										<span class="badge badge-cyan">{{ client.documents|length }}</span>
									</td>
								{% endif %}
								<td class="text-muted">{{ client.createdAt|date('d/m/Y') }}</td>
								{# Actions column - controlled by permission #}
								{% if is_granted('clients.view_actions_column') %}
									<td>
										<div style="display: flex; gap: 0.5rem;">
											{# View button - controlled by permission #}
											{% if is_granted('clients.view_view_button') %}
												<a href="{{ path('app_client_show', {id: client.id}) }}" class="btn btn-sm btn-secondary">View</a>
											{% endif %}
											{# Documents button - controlled by document view permission #}
											{% if is_granted('documents.view_list') %}
												<a href="{{ path('app_document_list', {id: client.id}) }}" class="btn btn-sm btn-primary" title="View Documents">ğŸ“„</a>
											{% endif %}
										</div>
									</td>
								{% endif %}
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	{% endif %}

	<script>
		function filterClients() {
	const input = document.getElementById('clientSearch');
	const filter = input.value.toLowerCase();
	const table = document.getElementById('clientsTable');
	const rows = table.getElementsByTagName('tr');

	for (let i = 1; i < rows.length; i++) {
	const nameCell = rows[i].getElementsByTagName('td')[0];
	const emailCell = rows[i].getElementsByTagName('td')[1];
	const nameText = nameCell ? nameCell.textContent.toLowerCase() : '';
	const emailText = emailCell ? emailCell.textContent.toLowerCase() : '';

	if (nameText.includes(filter) || emailText.includes(filter)) {
	rows[i].style.display = '';
	} else {
	rows[i].style.display = 'none';
	}
}
}
	</script>
{% endblock %}
